(function(){var root=this;var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;var Backbone;if(typeof exports!=='undefined'){Backbone=exports;}else{Backbone=root.Backbone={};}
Backbone.VERSION='1.0.0';var _=root._;if(!_&&(typeof require!=='undefined'))_=require('underscore');Backbone.$=root.jQuery||root.Zepto||root.ender||root.$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this;};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,'on',name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this;},once:function(name,callback,context){if(!eventsApi(this,'once',name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments);});once._callback=callback;return this.on(name,once,context);},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,'off',name,[callback,context]))return this;if(!name&&!callback&&!context){this._events={};return this;}
names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if((callback&&callback!==ev.callback&&callback!==ev.callback._callback)||(context&&context!==ev.context)){retain.push(ev);}}}
if(!retain.length)delete this._events[name];}}
return this;},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,'trigger',name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this;},stopListening:function(obj,name,callback){var listeners=this._listeners;if(!listeners)return this;var deleteListener=!name&&!callback;if(typeof name==='object')callback=this;if(obj)(listeners={})[obj._listenerId]=obj;for(var id in listeners){listeners[id].off(name,callback,this);if(deleteListener)delete this._listeners[id];}
return this;}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==='object'){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest));}
return false;}
if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest));}
return false;}
return true;};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);}};var listenMethods={listenTo:'on',listenToOnce:'once'};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeners=this._listeners||(this._listeners={});var id=obj._listenerId||(obj._listenerId=_.uniqueId('l'));listeners[id]=obj;if(typeof name==='object')callback=this;obj[implementation](name,callback,this);return this;};});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var defaults;var attrs=attributes||{};options||(options={});this.cid=_.uniqueId('c');this.attributes={};_.extend(this,_.pick(options,modelOptions));if(options.parse)attrs=this.parse(attrs,options)||{};if(defaults=_.result(this,'defaults')){attrs=_.defaults({},attrs,defaults);}
this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments);};var modelOptions=['url','urlRoot','collection'];_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:'id',initialize:function(){},toJSON:function(options){return _.clone(this.attributes);},sync:function(){return Backbone.sync.apply(this,arguments);},get:function(attr){return this.attributes[attr];},escape:function(attr){return _.escape(this.get(attr));},has:function(attr){return this.get(attr)!=null;},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={};}
current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val;}else{delete this.changed[attr];}
unset?delete current[attr]:current[attr]=val;}
if(!silent){if(changes.length)this._pending=true;for(var i=0,l=changes.length;i<l;i++){this.trigger('change:'+changes[i],this,current[changes[i]],options);}}
if(changing)return this;if(!silent){while(this._pending){this._pending=false;this.trigger('change',this,options);}}
this._pending=false;this._changing=false;return this;},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}));},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}));},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr);},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],(val=diff[attr])))continue;(changed||(changed={}))[attr]=val;}
return changed;},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr];},previousAttributes:function(){return _.clone(this._previousAttributes);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);return this.sync('read',this,options);},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
if(attrs&&(!options||!options.wait)&&!this.set(attrs,options))return false;options=_.extend({validate:true},options);if(!this._validate(attrs,options))return false;if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs);}
if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false;}
if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);method=this.isNew()?'create':(options.patch?'patch':'update');if(method==='patch')options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr;},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger('destroy',model,model.collection,options);};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger('sync',model,resp,options);};if(this.isNew()){options.success();return false;}
wrapError(this,options);var xhr=this.sync('delete',this,options);if(!options.wait)destroy();return xhr;},url:function(){var base=_.result(this,'urlRoot')||_.result(this.collection,'url')||urlError();if(this.isNew())return base;return base+(base.charAt(base.length-1)==='/'?'':'/')+encodeURIComponent(this.id);},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.attributes);},isNew:function(){return this.id==null;},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}));},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger('invalid',this,error,_.extend(options||{},{validationError:error}));return false;}});var modelMethods=['keys','values','pairs','invert','pick','omit'];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args);};});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.url)this.url=options.url;if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options));};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,merge:false,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options);});},sync:function(){return Backbone.sync.apply(this,arguments);},add:function(models,options){return this.set(models,_.defaults(options||{},addOptions));},remove:function(models,options){models=_.isArray(models)?models.slice():[models];options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger('remove',model,this,options);}
this._removeReference(model);}
return this;},set:function(models,options){options=_.defaults(options||{},setOptions);if(options.parse)models=this.parse(models,options);if(!_.isArray(models))models=models?[models]:[];var i,l,model,attrs,existing,sort;var at=options.at;var sortable=this.comparator&&(at==null)&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};for(i=0,l=models.length;i<l;i++){if(!(model=this._prepareModel(models[i],options)))continue;if(existing=this.get(model)){if(options.remove)modelMap[existing.cid]=true;if(options.merge){existing.set(model.attributes,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true;}}else if(options.add){toAdd.push(model);model.on('all',this._onModelEvent,this);this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model;}}
if(options.remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model);}
if(toRemove.length)this.remove(toRemove,options);}
if(toAdd.length){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){splice.apply(this.models,[at,0].concat(toAdd));}else{push.apply(this.models,toAdd);}}
if(sort)this.sort({silent:true});if(options.silent)return this;for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger('add',model,this,options);}
if(sort)this.trigger('sort',this,options);return this;},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i]);}
options.previousModels=this.models;this._reset();this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger('reset',this,options);return this;},push:function(model,options){model=this._prepareModel(model,options);this.add(model,_.extend({at:this.length},options));return model;},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model;},unshift:function(model,options){model=this._prepareModel(model,options);this.add(model,_.extend({at:0},options));return model;},shift:function(options){var model=this.at(0);this.remove(model,options);return model;},slice:function(begin,end){return this.models.slice(begin,end);},get:function(obj){if(obj==null)return void 0;return this._byId[obj.id!=null?obj.id:obj.cid||obj];},at:function(index){return this.models[index];},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?'find':'filter'](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false;}
return true;});},findWhere:function(attrs){return this.where(attrs,true);},sort:function(options){if(!this.comparator)throw new Error('Cannot sort a set without a comparator');options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this);}else{this.models.sort(_.bind(this.comparator,this));}
if(!options.silent)this.trigger('sort',this,options);return this;},sortedIndex:function(model,value,context){value||(value=this.comparator);var iterator=_.isFunction(value)?value:function(model){return model.get(value);};return _.sortedIndex(this.models,model,iterator,context);},pluck:function(attr){return _.invoke(this.models,'get',attr);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?'reset':'set';collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger('sync',collection,resp,options);};wrapError(this,options);return this.sync('read',this,options);},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(resp){if(options.wait)collection.add(model,options);if(success)success(model,resp,options);};model.save(null,options);return model;},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.models);},_reset:function(){this.length=0;this.models=[];this._byId={};},_prepareModel:function(attrs,options){if(attrs instanceof Model){if(!attrs.collection)attrs.collection=this;return attrs;}
options||(options={});options.collection=this;var model=new this.model(attrs,options);if(!model._validate(attrs,options)){this.trigger('invalid',this,attrs,options);return false;}
return model;},_removeReference:function(model){if(this===model.collection)delete model.collection;model.off('all',this._onModelEvent,this);},_onModelEvent:function(event,model,collection,options){if((event==='add'||event==='remove')&&collection!==this)return;if(event==='destroy')this.remove(model,options);if(model&&event==='change:'+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model;}
this.trigger.apply(this,arguments);}});var methods=['forEach','each','map','collect','reduce','foldl','inject','reduceRight','foldr','find','detect','filter','select','reject','every','all','some','any','include','contains','invoke','max','min','toArray','size','first','head','take','initial','rest','tail','drop','last','without','indexOf','shuffle','lastIndexOf','isEmpty','chain'];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args);};});var attributeMethods=['groupBy','countBy','sortBy'];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value);};return _[method](this.models,iterator,context);};});var View=Backbone.View=function(options){this.cid=_.uniqueId('view');this._configure(options||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents();};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=['model','collection','el','id','attributes','className','tagName','events'];_.extend(View.prototype,Events,{tagName:'div',$:function(selector){return this.$el.find(selector);},initialize:function(){},render:function(){return this;},remove:function(){this.$el.remove();this.stopListening();return this;},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this;},delegateEvents:function(events){if(!(events||(events=_.result(this,'events'))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+='.delegateEvents'+this.cid;if(selector===''){this.$el.on(eventName,method);}else{this.$el.on(eventName,selector,method);}}
return this;},undelegateEvents:function(){this.$el.off('.delegateEvents'+this.cid);return this;},_configure:function(options){if(this.options)options=_.extend({},_.result(this,'options'),options);_.extend(this,_.pick(options,viewOptions));this.options=options;},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,'attributes'));if(this.id)attrs.id=_.result(this,'id');if(this.className)attrs['class']=_.result(this,'className');var $el=Backbone.$('<'+_.result(this,'tagName')+'>').attr(attrs);this.setElement($el,false);}else{this.setElement(_.result(this,'el'),false);}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:'json'};if(!options.url){params.url=_.result(model,'url')||urlError();}
if(options.data==null&&model&&(method==='create'||method==='update'||method==='patch')){params.contentType='application/json';params.data=JSON.stringify(options.attrs||model.toJSON(options));}
if(options.emulateJSON){params.contentType='application/x-www-form-urlencoded';params.data=params.data?{model:params.data}:{};}
if(options.emulateHTTP&&(type==='PUT'||type==='DELETE'||type==='PATCH')){params.type='POST';if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader('X-HTTP-Method-Override',type);if(beforeSend)return beforeSend.apply(this,arguments);};}
if(params.type!=='GET'&&!options.emulateJSON){params.processData=false;}
if(params.type==='PATCH'&&window.ActiveXObject&&!(window.external&&window.external.msActiveXFilteringEnabled)){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP");};}
var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger('request',model,xhr,options);return xhr;};var methodMap={'create':'POST','update':'PUT','patch':'PATCH','delete':'DELETE','read':'GET'};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments);};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments);};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name='';}
if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args);router.trigger.apply(router,['route:'+name].concat(args));router.trigger('route',name,args);Backbone.history.trigger('route',router,name,args);});return this;},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this;},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,'routes');var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route]);}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,'\\$&').replace(optionalParam,'(?:$1)?').replace(namedParam,function(match,optional){return optional?match:'([^\/]+)';}).replace(splatParam,'(.*?)');return new RegExp('^'+route+'$');},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null;});}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,'checkUrl');if(typeof window!=='undefined'){this.location=window.location;this.history=window.history;}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;History.started=false;_.extend(History.prototype,Events,{interval:50,getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:'';},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,'');if(!fragment.indexOf(root))fragment=fragment.substr(root.length);}else{fragment=this.getHash();}}
return fragment.replace(routeStripper,'');},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({},{root:'/'},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=(isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7));this.root=('/'+this.root+'/').replace(rootStripper,'/');if(oldIE&&this._wantsHashChange){this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo('body')[0].contentWindow;this.navigate(fragment);}
if(this._hasPushState){Backbone.$(window).on('popstate',this.checkUrl);}else if(this._wantsHashChange&&('onhashchange'in window)&&!oldIE){Backbone.$(window).on('hashchange',this.checkUrl);}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval);}
this.fragment=fragment;var loc=this.location;var atRoot=loc.pathname.replace(/[^\/]$/,'$&/')===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!atRoot){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+'#'+this.fragment);return true;}else if(this._wantsPushState&&this._hasPushState&&atRoot&&loc.hash){this.fragment=this.getHash().replace(routeStripper,'');this.history.replaceState({},document.title,this.root+this.fragment+loc.search);}
if(!this.options.silent)return this.loadUrl();},stop:function(){Backbone.$(window).off('popstate',this.checkUrl).off('hashchange',this.checkUrl);clearInterval(this._checkUrlInterval);History.started=false;},route:function(route,callback){this.handlers.unshift({route:route,callback:callback});},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe));}
if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl()||this.loadUrl(this.getHash());},loadUrl:function(fragmentOverride){var fragment=this.fragment=this.getFragment(fragmentOverride);var matched=_.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true;}});return matched;},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:options};fragment=this.getFragment(fragment||'');if(this.fragment===fragment)return;this.fragment=fragment;var url=this.root+fragment;if(this._hasPushState){this.history[options.replace?'replaceState':'pushState']({},document.title,url);}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&(fragment!==this.getFragment(this.getHash(this.iframe)))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace);}}else{return this.location.assign(url);}
if(options.trigger)this.loadUrl(fragment);},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,'');location.replace(href+'#'+fragment);}else{location.hash='#'+fragment;}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,'constructor')){child=protoProps.constructor;}else{child=function(){return parent.apply(this,arguments);};}
_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child;};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child;};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified');};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger('error',model,resp,options);};};}).call(this);jQuery.fn.sortElements=(function(){var sort=[].sort;return function(comparator,getSortable){getSortable=getSortable||function(){return this;};var placements=this.map(function(){var sortElement=getSortable.call(this),parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(''),sortElement.nextSibling);return function(){if(parentNode===this){throw new Error("You can't sort elements if any one is a descendant of another.");}
parentNode.insertBefore(this,nextSibling);parentNode.removeChild(nextSibling);};});return sort.call(this,comparator).each(function(i){placements[i].call(getSortable.call(this));});};})();if(typeof exports==='object'){var _=require('lodash');}
var joint={dia:{},ui:{},layout:{},shapes:{},format:{},util:{hashCode:function(str){var hash=0;if(str.length==0)return hash;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);hash=((hash<<5)-hash)+c;hash=hash&hash;}
return hash;},getByPath:function(obj,path,delim){delim=delim||'.';var keys=path.split(delim);var key;while(keys.length){key=keys.shift();if(key in obj){obj=obj[key];}else{return undefined;}}
return obj;},setByPath:function(obj,path,value,delim){delim=delim||'.';var keys=path.split(delim);var diver=obj;var i=0;if(path.indexOf(delim)>-1){for(var len=keys.length;i<len-1;i++){diver=diver[keys[i]]||(diver[keys[i]]={});}
diver[keys[len-1]]=value;}else{obj[path]=value;}
return obj;},flattenObject:function(obj,delim,stop){delim=delim||'.';var ret={};for(var key in obj){if(!obj.hasOwnProperty(key))continue;var shouldGoDeeper=typeof obj[key]==='object';if(shouldGoDeeper&&stop&&stop(obj[key])){shouldGoDeeper=false;}
if(shouldGoDeeper){var flatObject=this.flattenObject(obj[key],delim,stop);for(var flatKey in flatObject){if(!flatObject.hasOwnProperty(flatKey))continue;ret[key+delim+flatKey]=flatObject[flatKey];}}else{ret[key]=obj[key];}}
return ret;},uuid:function(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});},guid:function(obj){this.guid.id=this.guid.id||1;obj.id=(obj.id===undefined?'j_'+this.guid.id++:obj.id);return obj.id;},mixin:function(){var target=arguments[0];for(var i=1,l=arguments.length;i<l;i++){var extension=arguments[i];if((Object(extension)!==extension)&&!_.isFunction(extension)&&(extension===null||extension===undefined)){continue;}
_.each(extension,function(copy,key){if(this.mixin.deep&&(Object(copy)===copy)){if(!target[key]){target[key]=_.isArray(copy)?[]:{};}
this.mixin(target[key],copy);return;}
if(target[key]!==copy){if(!this.mixin.supplement||!target.hasOwnProperty(key)){target[key]=copy;}}},this);}
return target;},supplement:function(){this.mixin.supplement=true;var ret=this.mixin.apply(this,arguments);this.mixin.supplement=false;return ret;},deepMixin:function(){this.mixin.deep=true;var ret=this.mixin.apply(this,arguments);this.mixin.deep=false;return ret;},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=true;var ret=this.mixin.apply(this,arguments);this.mixin.deep=this.mixin.supplement=false;return ret;},normalizeEvent:function(evt){return(evt.originalEvent&&evt.originalEvent.changedTouches&&evt.originalEvent.changedTouches.length)?evt.originalEvent.changedTouches[0]:evt;},nextFrame:(function(){var raf;var client=typeof window!='undefined';if(client){raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;}
if(!raf){var lastTime=0;raf=function(callback){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=setTimeout(function(){callback(currTime+timeToCall);},timeToCall);lastTime=currTime+timeToCall;return id;};}
return client?_.bind(raf,window):raf;})(),cancelFrame:(function(){var caf;var client=typeof window!='undefined';if(client){caf=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame;}
caf=caf||clearTimeout;return client?_.bind(caf,window):caf;})(),timing:{linear:function(t){return t;},quad:function(t){return t*t;},cubic:function(t){return t*t*t;},inout:function(t){if(t<=0)return 0;if(t>=1)return 1;var t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75);},exponential:function(t){return Math.pow(2,10*(t-1));},bounce:function(t){for(var a=0,b=1;1;a+=b,b/=2){if(t>=(7-4*a)/11){var q=(11-6*a-11*t)/4;return-q*q+b*b;}}},reverse:function(f){return function(t){return 1-f(1-t)}},reflect:function(f){return function(t){return.5*(t<.5?f(2*t):(2-f(2-2*t)));};},clamp:function(f,n,x){n=n||0;x=x||1;return function(t){var r=f(t);return r<n?n:r>x?x:r;}},back:function(s){if(!s)s=1.70158;return function(t){return t*t*((s+1)*t-s);};},elastic:function(x){if(!x)x=1.5;return function(t){return Math.pow(2,10*(t-1))*Math.cos(20*Math.PI*x/3*t);}}},interpolate:{number:function(a,b){var d=b-a;return function(t){return a+d*t;};},object:function(a,b){var s=_.keys(a);return function(t){var i,p,r={};for(i=s.length-1;i!=-1;i--){p=s[i];r[p]=a[p]+(b[p]-a[p])*t;}
return r;}},hexColor:function(a,b){var ca=parseInt(a.slice(1),16),cb=parseInt(b.slice(1),16);var ra=ca&0x0000ff,rd=(cb&0x0000ff)-ra;var ga=ca&0x00ff00,gd=(cb&0x00ff00)-ga;var ba=ca&0xff0000,bd=(cb&0xff0000)-ba;return function(t){return'#'+(1<<24|(ra+rd*t)|(ga+gd*t)|(ba+bd*t)).toString(16).slice(1);};},unit:function(a,b){var r=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/;var ma=r.exec(a),mb=r.exec(b);var p=mb[1].indexOf('.'),f=p>0?mb[1].length-p-1:0;var a=+ma[1],d=+mb[1]-a,u=ma[2];return function(t){return(a+d*t).toFixed(f)+u;}}},filter:{blur:function(args){var x=_.isFinite(args.x)?args.x:2;return _.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>',{stdDeviation:_.isFinite(args.y)?[x,args.y]:x});},dropShadow:function(args){return _.template('<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>',{dx:args.dx||0,dy:args.dy||0,color:args.color||'black',blur:_.isFinite(args.blur)?args.blur:4});},grayscale:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>',{a:0.2126+0.7874*(1-amount),b:0.7152-0.7152*(1-amount),c:0.0722-0.0722*(1-amount),d:0.2126-0.2126*(1-amount),e:0.7152+0.2848*(1-amount),f:0.0722-0.0722*(1-amount),g:0.2126-0.2126*(1-amount),h:0.0722+0.9278*(1-amount)});},sepia:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>',{a:0.393+0.607*(1-amount),b:0.769-0.769*(1-amount),c:0.189-0.189*(1-amount),d:0.349-0.349*(1-amount),e:0.686+0.314*(1-amount),f:0.168-0.168*(1-amount),g:0.272-0.272*(1-amount),h:0.534-0.534*(1-amount),i:0.131+0.869*(1-amount)});},saturate:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return _.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>',{amount:1-amount});},hueRotate:function(args){return _.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>',{angle:args.angle||0});},invert:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>',{amount:amount,amount2:1-amount});},brightness:function(args){return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>',{amount:_.isFinite(args.amount)?args.amount:1});},contrast:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>',{amount:amount,amount2:.5-amount/2});}}}};if(typeof exports==='object'){module.exports=joint;}
(function(root,factory){if(typeof define==='function'&&define.amd){define(['lodash'],factory);}else{root.Vectorizer=root.V=factory(root._);}}(this,function(_){var SVGsupported=!!(window.SVGAngle||document.implementation.hasFeature('http://www.w3.org/TR/SVG11/feature#BasicStructure','1.1'));var ns={xmlns:'http://www.w3.org/2000/svg',xlink:'http://www.w3.org/1999/xlink'};var SVGversion='1.1';function createElement(el,attrs,children){if(!el)return undefined;if(typeof el==='object'){return new VElement(el);}
attrs=attrs||{};if(el.toLowerCase()==='svg'){attrs.xmlns=ns.xmlns;attrs['xmlns:xlink']=ns.xlink;attrs.version=SVGversion;}else if(el[0]==='<'){var svg='<svg xmlns="'+ns.xmlns+'" xmlns:xlink="'+ns.xlink+'" version="'+SVGversion+'">'+el+'</svg>';var parser=new DOMParser();parser.async=false;var svgDoc=parser.parseFromString(svg,'text/xml').documentElement;if(svgDoc.childNodes.length>1){return _.map(svgDoc.childNodes,function(childNode){return new VElement(document.importNode(childNode,true));});}
return new VElement(document.importNode(svgDoc.firstChild,true));}
el=document.createElementNS(ns.xmlns,el);for(var key in attrs){setAttribute(el,key,attrs[key]);}
if(Object.prototype.toString.call(children)!='[object Array]')children=[children];var i=0,len=(children[0]&&children.length)||0,child;for(;i<len;i++){child=children[i];el.appendChild(child instanceof VElement?child.node:child);}
return new VElement(el);}
function setAttribute(el,name,value){if(name.indexOf(':')>-1){var combinedKey=name.split(':');el.setAttributeNS(ns[combinedKey[0]],combinedKey[1],value);}else if(name==='id'){el.id=value;}else{el.setAttribute(name,value);}}
function parseTransformString(transform){var translate,rotate,scale;if(transform){var translateMatch=transform.match(/translate\((.*)\)/);if(translateMatch){translate=translateMatch[1].split(',');}
var rotateMatch=transform.match(/rotate\((.*)\)/);if(rotateMatch){rotate=rotateMatch[1].split(',');}
var scaleMatch=transform.match(/scale\((.*)\)/);if(scaleMatch){scale=scaleMatch[1].split(',');}}
var sx=(scale&&scale[0])?parseFloat(scale[0]):1;return{translate:{tx:(translate&&translate[0])?parseInt(translate[0],10):0,ty:(translate&&translate[1])?parseInt(translate[1],10):0},rotate:{angle:(rotate&&rotate[0])?parseInt(rotate[0],10):0,cx:(rotate&&rotate[1])?parseInt(rotate[1],10):undefined,cy:(rotate&&rotate[2])?parseInt(rotate[2],10):undefined},scale:{sx:sx,sy:(scale&&scale[1])?parseFloat(scale[1]):sx}};}
function deltaTransformPoint(matrix,point){var dx=point.x*matrix.a+point.y*matrix.c+0;var dy=point.x*matrix.b+point.y*matrix.d+0;return{x:dx,y:dy};}
function decomposeMatrix(matrix){var px=deltaTransformPoint(matrix,{x:0,y:1});var py=deltaTransformPoint(matrix,{x:1,y:0});var skewX=((180/Math.PI)*Math.atan2(px.y,px.x)-90);var skewY=((180/Math.PI)*Math.atan2(py.y,py.x));return{translateX:matrix.e,translateY:matrix.f,scaleX:Math.sqrt(matrix.a*matrix.a+matrix.b*matrix.b),scaleY:Math.sqrt(matrix.c*matrix.c+matrix.d*matrix.d),skewX:skewX,skewY:skewY,rotation:skewX};}
function VElement(el){this.node=el;if(!this.node.id){this.node.id=_.uniqueId('v_');}}
VElement.prototype={translate:function(tx,ty){ty=ty||0;var transformAttr=this.attr('transform')||'',transform=parseTransformString(transformAttr);if(typeof tx==='undefined'){return transform.translate;}
transformAttr=transformAttr.replace(/translate\([^\)]*\)/g,'').trim();var newTx=transform.translate.tx+tx,newTy=transform.translate.ty+ty;this.attr('transform','translate('+newTx+','+newTy+') '+transformAttr);return this;},rotate:function(angle,cx,cy){var transformAttr=this.attr('transform')||'',transform=parseTransformString(transformAttr);if(typeof angle==='undefined'){return transform.rotate;}
transformAttr=transformAttr.replace(/rotate\([^\)]*\)/g,'').trim();var newAngle=transform.rotate.angle+angle%360,newOrigin=(cx!==undefined&&cy!==undefined)?','+cx+','+cy:'';this.attr('transform',transformAttr+' rotate('+newAngle+newOrigin+')');return this;},scale:function(sx,sy){sy=(typeof sy==='undefined')?sx:sy;var transformAttr=this.attr('transform')||'',transform=parseTransformString(transformAttr);if(typeof sx==='undefined'){return transform.scale;}
transformAttr=transformAttr.replace(/scale\([^\)]*\)/g,'').trim();this.attr('transform',transformAttr+' scale('+sx+','+sy+')');return this;},bbox:function(withoutTransformations,target){if(!this.node.ownerSVGElement)return{x:0,y:0,width:0,height:0};var box;try{box=this.node.getBBox();box={x:box.x|0,y:box.y|0,width:box.width|0,height:box.height|0};}catch(e){box={x:this.node.clientLeft,y:this.node.clientTop,width:this.node.clientWidth,height:this.node.clientHeight};}
if(withoutTransformations){return box;}
var matrix=this.node.getTransformToElement(target||this.node.ownerSVGElement);var corners=[];var point=this.node.ownerSVGElement.createSVGPoint();point.x=box.x;point.y=box.y;corners.push(point.matrixTransform(matrix));point.x=box.x+box.width;point.y=box.y;corners.push(point.matrixTransform(matrix));point.x=box.x+box.width;point.y=box.y+box.height;corners.push(point.matrixTransform(matrix));point.x=box.x;point.y=box.y+box.height;corners.push(point.matrixTransform(matrix));var minX=corners[0].x;var maxX=minX;var minY=corners[0].y;var maxY=minY;for(var i=1,len=corners.length;i<len;i++){var x=corners[i].x;var y=corners[i].y;if(x<minX){minX=x;}else if(x>maxX){maxX=x;}
if(y<minY){minY=y;}else if(y>maxY){maxY=y;}}
return{x:minX,y:minY,width:maxX-minX,height:maxY-minY};},text:function(content){var lines=content.split('\n'),i=0,tspan;this.attr('y','0.8em');if(lines.length===1){this.node.textContent=content;return this;}
this.node.textContent='';for(;i<lines.length;i++){tspan=V('tspan',{dy:(i==0?'0em':'1em'),x:this.attr('x')||0});tspan.node.textContent=lines[i];this.append(tspan);}
return this;},attr:function(name,value){if(typeof name==='string'&&typeof value==='undefined'){return this.node.getAttribute(name);}
if(typeof name==='object'){_.each(name,function(value,name){setAttribute(this.node,name,value);},this);}else{setAttribute(this.node,name,value);}
return this;},remove:function(){if(this.node.parentNode){this.node.parentNode.removeChild(this.node);}},append:function(el){var els=el;if(!_.isArray(el)){els=[el];}
_.each(els,function(el){this.node.appendChild(el instanceof VElement?el.node:el);},this);return this;},prepend:function(el){this.node.insertBefore(el instanceof VElement?el.node:el,this.node.firstChild);},svg:function(){return this.node instanceof window.SVGSVGElement?this:V(this.node.ownerSVGElement);},defs:function(){var defs=this.svg().node.getElementsByTagName('defs');return(defs&&defs.length)?V(defs[0]):undefined;},clone:function(){var clone=V(this.node.cloneNode(true));clone.node.id=_.uniqueId('v-');return clone;},toLocalPoint:function(x,y){var svg=this.svg().node;var p=svg.createSVGPoint();p.x=x;p.y=y;try{var globalPoint=p.matrixTransform(svg.getScreenCTM().inverse());var globalToLocalMatrix=this.node.getTransformToElement(svg).inverse();}catch(e){return p;}
return globalPoint.matrixTransform(globalToLocalMatrix);},translateCenterToPoint:function(p){var bbox=this.bbox();var center=g.rect(bbox).center();this.translate(p.x-center.x,p.y-center.y);},translateAndAutoOrient:function(position,reference,target){var s=this.scale();this.attr('transform','');this.scale(s.sx,s.sy);var svg=this.svg().node;var bbox=this.bbox(false,target);var translateToOrigin=svg.createSVGTransform();translateToOrigin.setTranslate(-bbox.x-bbox.width/2,-bbox.y-bbox.height/2);var rotateAroundOrigin=svg.createSVGTransform();var angle=g.point(position).changeInAngle(position.x-reference.x,position.y-reference.y,reference);rotateAroundOrigin.setRotate(angle,0,0);var translateFinal=svg.createSVGTransform();var finalPosition=g.point(position).move(reference,bbox.width/2);translateFinal.setTranslate(position.x+(position.x-finalPosition.x),position.y+(position.y-finalPosition.y));var ctm=this.node.getTransformToElement(target);var transform=svg.createSVGTransform();transform.setMatrix(translateFinal.matrix.multiply(rotateAroundOrigin.matrix.multiply(translateToOrigin.matrix.multiply(ctm))));var decomposition=decomposeMatrix(transform.matrix);this.translate(decomposition.translateX,decomposition.translateY);this.rotate(decomposition.rotation);return this;},animateAlongPath:function(attrs,path){var animateMotion=V('animateMotion',attrs);var mpath=V('mpath',{'xlink:href':'#'+V(path).node.id});animateMotion.append(mpath);this.append(animateMotion);try{animateMotion.node.beginElement();}catch(e){if(document.documentElement.getAttribute('smiling')==='fake'){var animation=animateMotion.node;animation.animators=new Array();var animationID=animation.getAttribute('id');if(animationID)id2anim[animationID]=animation;_.each(getTargets(animation),function(target,index){var animator=new Animator(animation,target,index);animators.push(animator);animation.animators[index]=animator;});_.invoke(animation.animators,'register');}}},hasClass:function(className){return new RegExp('(\\s|^)'+className+'(\\s|$)').test(this.node.getAttribute('class'));},addClass:function(className){if(!this.hasClass(className)){this.node.setAttribute('class',this.node.getAttribute('class')+' '+className);}},removeClass:function(className){var removedClass=this.node.getAttribute('class').replace(new RegExp('(\\s|^)'+className+'(\\s|$)','g'),'$2');if(this.hasClass(className)){this.node.setAttribute('class',removedClass);}},toggleClass:function(className,toAdd){var toRemove=typeof toAdd==='undefined'?this.hasClass(className):!toAdd;if(toRemove){this.removeClass(className);}else{this.addClass(className);}}};var V=createElement;V.decomposeMatrix=decomposeMatrix;var svgDocument=V('svg').node;V.createSVGMatrix=function(m){return _.extend(svgDocument.createSVGMatrix(),m);};V.createSVGTransform=function(){return svgDocument.createSVGTransform();};V.createSVGPoint=function(x,y){var p=svgDocument.createSVGPoint();p.x=x;p.y=y;return p;};return V;}));(function(root,factory){if(typeof define==='function'&&define.amd){define([],factory);}else{root.g=factory();}}(this,function(){var math=Math;var abs=math.abs;var cos=math.cos;var sin=math.sin;var sqrt=math.sqrt;var mmin=math.min;var mmax=math.max;var atan=math.atan;var atan2=math.atan2;var acos=math.acos;var round=math.round;var floor=math.floor;var PI=math.PI;var random=math.random;var toDeg=function(rad){return(180*rad/PI)%360;};var toRad=function(deg){return(deg%360)*PI/180;};var snapToGrid=function(val,gridSize){return gridSize*Math.round(val/gridSize);};var normalizeAngle=function(angle){return(angle%360)+(angle<0?360:0);};function point(x,y){if(!(this instanceof point))
return new point(x,y);var xy;if(y===undefined&&Object(x)!==x){xy=x.split(_.indexOf(x,"@")===-1?" ":"@");this.x=parseInt(xy[0],10);this.y=parseInt(xy[1],10);}else if(Object(x)===x){this.x=x.x;this.y=x.y;}else{this.x=x;this.y=y;}}
point.prototype={toString:function(){return this.x+"@"+this.y;},adhereToRect:function(r){if(r.containsPoint(this)){return this;}
this.x=mmin(mmax(this.x,r.x),r.x+r.width);this.y=mmin(mmax(this.y,r.y),r.y+r.height);return this;},theta:function(p){p=point(p);var y=-(p.y-this.y);var x=p.x-this.x;var PRECISION=10;var rad=(y.toFixed(PRECISION)==0&&x.toFixed(PRECISION)==0)?0:atan2(y,x);if(rad<0){rad=2*PI+rad;}
return 180*rad/PI;},distance:function(p){return line(this,p).length();},manhattanDistance:function(p){return abs(p.x-this.x)+abs(p.y-this.y);},offset:function(dx,dy){this.x+=dx||0;this.y+=dy||0;return this;},magnitude:function(){return sqrt((this.x*this.x)+(this.y*this.y))||0.01;},update:function(x,y){this.x=x||0;this.y=y||0;return this;},round:function(decimals){this.x=decimals?this.x.toFixed(decimals):round(this.x);this.y=decimals?this.y.toFixed(decimals):round(this.y);return this;},normalize:function(len){var s=(len||1)/this.magnitude();this.x=s*this.x;this.y=s*this.y;return this;},difference:function(p){return point(this.x-p.x,this.y-p.y);},toPolar:function(o){o=(o&&point(o))||point(0,0);var x=this.x;var y=this.y;this.x=sqrt((x-o.x)*(x-o.x)+(y-o.y)*(y-o.y));this.y=toRad(o.theta(point(x,y)));return this;},rotate:function(o,angle){angle=(angle+360)%360;this.toPolar(o);this.y+=toRad(angle);var p=point.fromPolar(this.x,this.y,o);this.x=p.x;this.y=p.y;return this;},move:function(ref,distance){var theta=toRad(point(ref).theta(this));return this.offset(cos(theta)*distance,-sin(theta)*distance);},changeInAngle:function(dx,dy,ref){return point(this).offset(-dx,-dy).theta(ref)-this.theta(ref);},equals:function(p){return this.x===p.x&&this.y===p.y;}};point.fromPolar=function(r,angle,o){o=(o&&point(o))||point(0,0);var x=abs(r*cos(angle));var y=abs(r*sin(angle));var deg=normalizeAngle(toDeg(angle));if(deg<90)y=-y;else if(deg<180){x=-x;y=-y;}
else if(deg<270)x=-x;return point(o.x+x,o.y+y);};point.random=function(x1,x2,y1,y2){return point(floor(random()*(x2-x1+1)+x1),floor(random()*(y2-y1+1)+y1));};function line(p1,p2){if(!(this instanceof line))
return new line(p1,p2);this.start=point(p1);this.end=point(p2);}
line.prototype={toString:function(){return this.start.toString()+' '+this.end.toString();},length:function(){return sqrt(this.squaredLength());},squaredLength:function(){var x0=this.start.x;var y0=this.start.y;var x1=this.end.x;var y1=this.end.y;return(x0-=x1)*x0+(y0-=y1)*y0;},midpoint:function(){return point((this.start.x+this.end.x)/2,(this.start.y+this.end.y)/2);},intersection:function(l){var pt1Dir=point(this.end.x-this.start.x,this.end.y-this.start.y);var pt2Dir=point(l.end.x-l.start.x,l.end.y-l.start.y);var det=(pt1Dir.x*pt2Dir.y)-(pt1Dir.y*pt2Dir.x);var deltaPt=point(l.start.x-this.start.x,l.start.y-this.start.y);var alpha=(deltaPt.x*pt2Dir.y)-(deltaPt.y*pt2Dir.x);var beta=(deltaPt.x*pt1Dir.y)-(deltaPt.y*pt1Dir.x);if(det===0||alpha*det<0||beta*det<0){return null;}
if(det>0){if(alpha>det||beta>det){return null;}}else{if(alpha<det||beta<det){return null;}}
return point(this.start.x+(alpha*pt1Dir.x/det),this.start.y+(alpha*pt1Dir.y/det));}};function rect(x,y,w,h){if(!(this instanceof rect))
return new rect(x,y,w,h);if(y===undefined){y=x.y;w=x.width;h=x.height;x=x.x;}
this.x=x;this.y=y;this.width=w;this.height=h;}
rect.prototype={toString:function(){return this.origin().toString()+' '+this.corner().toString();},origin:function(){return point(this.x,this.y);},corner:function(){return point(this.x+this.width,this.y+this.height);},topRight:function(){return point(this.x+this.width,this.y);},bottomLeft:function(){return point(this.x,this.y+this.height);},center:function(){return point(this.x+this.width/2,this.y+this.height/2);},intersect:function(r){var myOrigin=this.origin();var myCorner=this.corner();var rOrigin=r.origin();var rCorner=r.corner();if(rCorner.x<=myOrigin.x||rCorner.y<=myOrigin.y||rOrigin.x>=myCorner.x||rOrigin.y>=myCorner.y)return false;return true;},sideNearestToPoint:function(p){p=point(p);var distToLeft=p.x-this.x;var distToRight=(this.x+this.width)-p.x;var distToTop=p.y-this.y;var distToBottom=(this.y+this.height)-p.y;var closest=distToLeft;var side='left';if(distToRight<closest){closest=distToRight;side='right';}
if(distToTop<closest){closest=distToTop;side='top';}
if(distToBottom<closest){closest=distToBottom;side='bottom';}
return side;},containsPoint:function(p){p=point(p);if(p.x>=this.x&&p.x<=this.x+this.width&&p.y>=this.y&&p.y<=this.y+this.height){return true;}
return false;},pointNearestToPoint:function(p){p=point(p);if(this.containsPoint(p)){var side=this.sideNearestToPoint(p);switch(side){case"right":return point(this.x+this.width,p.y);case"left":return point(this.x,p.y);case"bottom":return point(p.x,this.y+this.height);case"top":return point(p.x,this.y);}}
return p.adhereToRect(this);},intersectionWithLineFromCenterToPoint:function(p,angle){p=point(p);var center=point(this.x+this.width/2,this.y+this.height/2);var result;if(angle)p.rotate(center,angle);var sides=[line(this.origin(),this.topRight()),line(this.topRight(),this.corner()),line(this.corner(),this.bottomLeft()),line(this.bottomLeft(),this.origin())];var connector=line(center,p);for(var i=sides.length-1;i>=0;--i){var intersection=sides[i].intersection(connector);if(intersection!==null){result=intersection;break;}}
if(result&&angle)result.rotate(center,-angle);return result;},moveAndExpand:function(r){this.x+=r.x;this.y+=r.y;this.width+=r.width;this.height+=r.height;return this;},round:function(decimals){this.x=decimals?this.x.toFixed(decimals):round(this.x);this.y=decimals?this.y.toFixed(decimals):round(this.y);this.width=decimals?this.width.toFixed(decimals):round(this.width);this.height=decimals?this.height.toFixed(decimals):round(this.height);return this;}};function ellipse(c,a,b){if(!(this instanceof ellipse))
return new ellipse(c,a,b);c=point(c);this.x=c.x;this.y=c.y;this.a=a;this.b=b;}
ellipse.prototype={toString:function(){return point(this.x,this.y).toString()+' '+this.a+' '+this.b;},bbox:function(){return rect(this.x-this.a,this.y-this.b,2*this.a,2*this.b);},intersectionWithLineFromCenterToPoint:function(p,angle){p=point(p);if(angle)p.rotate(point(this.x,this.y),angle);var dx=p.x-this.x;var dy=p.y-this.y;var result;if(dx===0){result=this.bbox().pointNearestToPoint(p);if(angle)return result.rotate(point(this.x,this.y),-angle);return result;}
var m=dy/dx;var mSquared=m*m;var aSquared=this.a*this.a;var bSquared=this.b*this.b;var x=sqrt(1/((1/aSquared)+(mSquared/bSquared)));x=dx<0?-x:x;var y=m*x;result=point(this.x+x,this.y+y);if(angle)return result.rotate(point(this.x,this.y),-angle);return result;}};var bezier={curveThroughPoints:function(points){var controlPoints=this.getCurveControlPoints(points);var path=['M',points[0].x,points[0].y];for(var i=0;i<controlPoints[0].length;i++){path.push('C',controlPoints[0][i].x,controlPoints[0][i].y,controlPoints[1][i].x,controlPoints[1][i].y,points[i+1].x,points[i+1].y);}
return path;},getCurveControlPoints:function(knots){var firstControlPoints=[];var secondControlPoints=[];var n=knots.length-1;var i;if(n==1){firstControlPoints[0]=point((2*knots[0].x+knots[1].x)/3,(2*knots[0].y+knots[1].y)/3);secondControlPoints[0]=point(2*firstControlPoints[0].x-knots[0].x,2*firstControlPoints[0].y-knots[0].y);return[firstControlPoints,secondControlPoints];}
var rhs=[];for(i=1;i<n-1;i++){rhs[i]=4*knots[i].x+2*knots[i+1].x;}
rhs[0]=knots[0].x+2*knots[1].x;rhs[n-1]=(8*knots[n-1].x+knots[n].x)/2.0;var x=this.getFirstControlPoints(rhs);for(i=1;i<n-1;++i){rhs[i]=4*knots[i].y+2*knots[i+1].y;}
rhs[0]=knots[0].y+2*knots[1].y;rhs[n-1]=(8*knots[n-1].y+knots[n].y)/2.0;var y=this.getFirstControlPoints(rhs);for(i=0;i<n;i++){firstControlPoints.push(point(x[i],y[i]));if(i<n-1){secondControlPoints.push(point(2*knots[i+1].x-x[i+1],2*knots[i+1].y-y[i+1]));}else{secondControlPoints.push(point((knots[n].x+x[n-1])/2,(knots[n].y+y[n-1])/2));}}
return[firstControlPoints,secondControlPoints];},getFirstControlPoints:function(rhs){var n=rhs.length;var x=[];var tmp=[];var b=2.0;x[0]=rhs[0]/b;for(var i=1;i<n;i++){tmp[i]=1/b;b=(i<n-1?4.0:3.5)-tmp[i];x[i]=(rhs[i]-x[i-1])/b;}
for(i=1;i<n;i++){x[n-i-1]-=tmp[n-i]*x[n-i];}
return x;}};return{toDeg:toDeg,toRad:toRad,snapToGrid:snapToGrid,normalizeAngle:normalizeAngle,point:point,line:line,rect:rect,ellipse:ellipse,bezier:bezier}}));if(typeof exports==='object'){var joint={dia:{Link:require('./joint.dia.link').Link,Element:require('./joint.dia.element').Element},shapes:require('../plugins/shapes')};var Backbone=require('backbone');var _=require('lodash');var g=require('./geometry').g;}
joint.dia.GraphCells=Backbone.Collection.extend({initialize:function(){this.on('change:z',this.sort,this);},model:function(attrs,options){if(attrs.type==='link'){return new joint.dia.Link(attrs,options);}
var module=attrs.type.split('.')[0];var entity=attrs.type.split('.')[1];if(joint.shapes[module]&&joint.shapes[module][entity]){return new joint.shapes[module][entity](attrs,options);}
return new joint.dia.Element(attrs,options);},comparator:function(model){return model.get('z')||0;},getConnectedLinks:function(model,opt){opt=opt||{};if(_.isUndefined(opt.inbound)&&_.isUndefined(opt.outbound)){opt.inbound=opt.outbound=true;}
var links=[];this.each(function(cell){var source=cell.get('source');var target=cell.get('target');if(source&&source.id===model.id&&opt.outbound){links.push(cell);}
if(target&&target.id===model.id&&opt.inbound){links.push(cell);}});return links;}});joint.dia.Graph=Backbone.Model.extend({initialize:function(){this.set('cells',new joint.dia.GraphCells);this.get('cells').on('all',this.trigger,this);this.get('cells').on('remove',this.removeCell,this);},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json.cells=this.get('cells').toJSON();return json;},fromJSON:function(json){if(!json.cells){throw new Error('Graph JSON must contain cells array.');}
var attrs=json;var cells=json.cells;delete attrs.cells;this.set(attrs);this.resetCells(cells);},clear:function(){this.get('cells').remove(this.get('cells').models);},_prepareCell:function(cell){if(cell instanceof Backbone.Model&&_.isUndefined(cell.get('z'))){cell.set('z',this.get('cells').length,{silent:true});}else if(_.isUndefined(cell.z)){cell.z=this.get('cells').length;}
return cell;},addCell:function(cell,options){if(_.isArray(cell)){return this.addCells(cell,options);}
this.get('cells').add(this._prepareCell(cell),options||{});return this;},addCells:function(cells,options){_.each(cells,function(cell){this.addCell(cell,options);},this);return this;},resetCells:function(cells){this.get('cells').reset(_.map(cells,this._prepareCell,this));return this;},removeCell:function(cell,collection,options){if(options&&options.disconnectLinks){this.disconnectLinks(cell);}else{this.removeLinks(cell);}
this.get('cells').remove(cell,{silent:true});},getCell:function(id){return this.get('cells').get(id);},getElements:function(){return this.get('cells').filter(function(cell){return cell instanceof joint.dia.Element;});},getLinks:function(){return this.get('cells').filter(function(cell){return cell instanceof joint.dia.Link;});},getConnectedLinks:function(model,opt){return this.get('cells').getConnectedLinks(model,opt);},getNeighbors:function(el){var links=this.getConnectedLinks(el);var neighbors=[];var cells=this.get('cells');_.each(links,function(link){var source=link.get('source');var target=link.get('target');if(!source.x){var sourceElement=cells.get(source.id);if(sourceElement!==el){neighbors.push(sourceElement);}}
if(!target.x){var targetElement=cells.get(target.id);if(targetElement!==el){neighbors.push(targetElement);}}});return neighbors;},disconnectLinks:function(model){_.each(this.getConnectedLinks(model),function(link){link.set(link.get('source').id===model.id?'source':'target',g.point(0,0));});},removeLinks:function(model){_.invoke(this.getConnectedLinks(model),'remove');},findModelsFromPoint:function(p){return _.filter(this.getElements(),function(el){return el.getBBox().containsPoint(p);});},findModelsInArea:function(r){return _.filter(this.getElements(),function(el){return el.getBBox().intersect(r);});}});if(typeof exports==='object'){module.exports.Graph=joint.dia.Graph;}
if(typeof exports==='object'){var joint={util:require('./core').util,dia:{Link:require('./joint.dia.link').Link}};var Backbone=require('backbone');var _=require('lodash');}
joint.dia.Cell=Backbone.Model.extend({constructor:function(attributes,options){var defaults;var attrs=attributes||{};this.cid=_.uniqueId('c');this.attributes={};if(options&&options.collection)this.collection=options.collection;if(options&&options.parse)attrs=this.parse(attrs,options)||{};if(defaults=_.result(this,'defaults')){attrs=_.merge({},defaults,attrs);}
this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments);},toJSON:function(){var defaultAttrs=this.constructor.prototype.defaults.attrs||{};var attrs=this.attributes.attrs;var finalAttrs={};_.each(attrs,function(attr,selector){var defaultAttr=defaultAttrs[selector];_.each(attr,function(value,name){if(_.isObject(value)&&!_.isArray(value)){_.each(value,function(value2,name2){if(!defaultAttr||!defaultAttr[name]||!_.isEqual(defaultAttr[name][name2],value2)){finalAttrs[selector]=finalAttrs[selector]||{};(finalAttrs[selector][name]||(finalAttrs[selector][name]={}))[name2]=value2;}});}else if(!defaultAttr||!_.isEqual(defaultAttr[name],value)){finalAttrs[selector]=finalAttrs[selector]||{};finalAttrs[selector][name]=value;}});});var attributes=_.cloneDeep(_.omit(this.attributes,'attrs'));attributes.attrs=finalAttrs;return attributes;},initialize:function(options){if(!options||!options.id){this.set('id',joint.util.uuid(),{silent:true});}
this._transitionIds={};this.processPorts();this.on('change:attrs',this.processPorts,this);},processPorts:function(){var previousPorts=this.ports;var ports={};_.each(this.get('attrs'),function(attrs,selector){if(attrs.port){if(!_.isUndefined(attrs.port.id)){ports[attrs.port.id]=attrs.port;}else{ports[attrs.port]={id:attrs.port};}}});var removedPorts={};_.each(previousPorts,function(port,id){if(!ports[id])removedPorts[id]=true;});if(this.collection&&!_.isEmpty(removedPorts)){var inboundLinks=this.collection.getConnectedLinks(this,{inbound:true});_.each(inboundLinks,function(link){if(removedPorts[link.get('target').port])link.remove();});var outboundLinks=this.collection.getConnectedLinks(this,{outbound:true});_.each(outboundLinks,function(link){if(removedPorts[link.get('source').port])link.remove();});}
this.ports=ports;},remove:function(options){var collection=this.collection;if(collection){collection.trigger('batch:start');}
var parentCellId=this.get('parent');if(parentCellId){var parentCell=this.collection&&this.collection.get(parentCellId);parentCell.unembed(this);}
_.invoke(this.getEmbeddedCells(),'remove',options);this.trigger('remove',this,this.collection,options);if(collection){collection.trigger('batch:stop');}},toFront:function(){if(this.collection){this.set('z',(this.collection.last().get('z')||0)+1);}},toBack:function(){if(this.collection){this.set('z',(this.collection.first().get('z')||0)-1);}},embed:function(cell){if(this.get('parent')==cell.id){throw new Error('Recursive embedding not allowed.');}else{this.trigger('batch:start');cell.set('parent',this.id);this.set('embeds',_.uniq((this.get('embeds')||[]).concat([cell.id])));this.trigger('batch:stop');}},unembed:function(cell){this.trigger('batch:start');var cellId=cell.id;cell.unset('parent');this.set('embeds',_.without(this.get('embeds'),cellId));this.trigger('batch:stop');},getEmbeddedCells:function(){if(this.collection){return _.map(this.get('embeds')||[],function(cellId){return this.collection.get(cellId);},this);}
return[];},clone:function(opt){opt=opt||{};var clone=Backbone.Model.prototype.clone.apply(this,arguments);clone.set('id',joint.util.uuid(),{silent:true});clone.set('embeds','');if(!opt.deep)return clone;var embeds=this.getEmbeddedCells();var clones=[clone];var linkCloneMapping={};_.each(embeds,function(embed){var embedClones=embed.clone({deep:true});clone.embed(embedClones[0]);_.each(embedClones,function(embedClone){clones.push(embedClone);if(embedClone instanceof joint.dia.Link){return;}
var inboundLinks=this.collection.getConnectedLinks(embed,{inbound:true});_.each(inboundLinks,function(link){var linkClone=linkCloneMapping[link.id]||link.clone();linkCloneMapping[link.id]=linkClone;var target=_.clone(linkClone.get('target'));target.id=embedClone.id;linkClone.set('target',target);});var outboundLinks=this.collection.getConnectedLinks(embed,{outbound:true});_.each(outboundLinks,function(link){var linkClone=linkCloneMapping[link.id]||link.clone();linkCloneMapping[link.id]=linkClone;var source=_.clone(linkClone.get('source'));source.id=embedClone.id;linkClone.set('source',source);});},this);},this);clones=clones.concat(_.values(linkCloneMapping));return clones;},attr:function(attrs,value,opt){var currentAttrs=this.get('attrs');var delim='/';if(_.isString(attrs)){if(value){var attr={};joint.util.setByPath(attr,attrs,value,delim);return this.set('attrs',_.merge({},currentAttrs,attr),opt);}else{return joint.util.getByPath(currentAttrs,attrs,delim);}}
return this.set('attrs',_.merge({},currentAttrs,attrs),value);},transition:function(path,value,opt,delim){delim=delim||'/';var defaults={duration:100,delay:10,timingFunction:joint.util.timing.linear,valueFunction:joint.util.interpolate.number};opt=_.extend(defaults,opt);var pathArray=path.split(delim);var property=pathArray[0];var isPropertyNested=pathArray.length>1;var firstFrameTime=0;var interpolatingFunction;var setter=_.bind(function(runtime){var id,progress,propertyValue,status;firstFrameTime=firstFrameTime||runtime;runtime-=firstFrameTime;progress=runtime/opt.duration;if(progress<1){this._transitionIds[path]=id=joint.util.nextFrame(setter);}else{progress=1;delete this._transitionIds[path];}
propertyValue=interpolatingFunction(opt.timingFunction(progress));if(isPropertyNested){var nestedPropertyValue=joint.util.setByPath({},path,propertyValue,delim)[property];propertyValue=_.merge({},this.get(property),nestedPropertyValue);}
opt.transitionId=id;this.set(property,propertyValue,opt);if(!id)this.trigger('transition:end',this,path);},this);var initiator=_.bind(function(callback){this.stopTransitions(path);interpolatingFunction=opt.valueFunction(joint.util.getByPath(this.attributes,path,delim),value);this._transitionIds[path]=joint.util.nextFrame(callback);this.trigger('transition:start',this,path);},this);return _.delay(initiator,opt.delay,setter);},getTransitions:function(){return _.keys(this._transitionIds);},stopTransitions:function(path,delim){delim=delim||'/';var pathArray=path&&path.split(delim);_(this._transitionIds).keys().filter(pathArray&&function(key){return _.isEqual(pathArray,key.split(delim).slice(0,pathArray.length));}).each(function(key){joint.util.cancelFrame(this._transitionIds[key]);delete this._transitionIds[key];this.trigger('transition:end',this,key);},this);}});joint.dia.CellView=Backbone.View.extend({tagName:'g',attributes:function(){return{'model-id':this.model.id}},initialize:function(){_.bindAll(this,'remove','update');this.$el.data('view',this);this.listenTo(this.model,'remove',this.remove);this.listenTo(this.model,'change:attrs',this.update);},_configure:function(options){options.id=options.id||joint.util.guid(this);Backbone.View.prototype._configure.apply(this,arguments);},_ensureElement:function(){var el;if(!this.el){var attrs=_.extend({id:this.id},_.result(this,'attributes'));if(this.className)attrs['class']=_.result(this,'className');el=V(_.result(this,'tagName'),attrs).node;}else{el=_.result(this,'el')}
this.setElement(el,false);},findBySelector:function(selector){var $selected=selector==='.'?this.$el:this.$el.find(selector);return $selected;},notify:function(evt){if(this.paper){var args=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[evt].concat(args));this.paper.trigger.apply(this.paper,[evt,this].concat(args));}},getStrokeBBox:function(el){var isMagnet=!!el;el=el||this.el;var bbox=V(el).bbox(false,this.paper.viewport);var strokeWidth;if(isMagnet){strokeWidth=V(el).attr('stroke-width');}else{strokeWidth=this.model.attr('rect/stroke-width')||this.model.attr('circle/stroke-width')||this.model.attr('ellipse/stroke-width')||this.model.attr('path/stroke-width');}
strokeWidth=parseFloat(strokeWidth)||0;return g.rect(bbox).moveAndExpand({x:-strokeWidth/2,y:-strokeWidth/2,width:strokeWidth,height:strokeWidth});},getBBox:function(){return V(this.el).bbox();},highlight:function(el){el=!el?this.el:this.$(el)[0]||this.el;V(el).addClass('highlighted');},unhighlight:function(el){el=!el?this.el:this.$(el)[0]||this.el;V(el).removeClass('highlighted');},findMagnet:function(el){var $el=this.$(el);if($el.length===0||$el[0]===this.el){var attrs=this.model.get('attrs')||{};if(attrs['.']&&attrs['.']['magnet']===false){return undefined;}
return this.el;}
if($el.attr('magnet')){return $el[0];}
return this.findMagnet($el.parent());},applyFilter:function(selector,filter){var $selected=this.findBySelector(selector);var filterId=filter.name+this.paper.svg.id+joint.util.hashCode(JSON.stringify(filter));if(!this.paper.svg.getElementById(filterId)){var filterSVGString=joint.util.filter[filter.name]&&joint.util.filter[filter.name](filter.args||{});if(!filterSVGString){throw new Error('Non-existing filter '+filter.name);}
var filterElement=V(filterSVGString);filterElement.attr('filterUnits','userSpaceOnUse');filterElement.node.id=filterId;V(this.paper.svg).defs().append(filterElement);}
$selected.each(function(){V(this).attr('filter','url(#'+filterId+')');});},applyGradient:function(selector,attr,gradient){var $selected=this.findBySelector(selector);var gradientId=gradient.type+this.paper.svg.id+joint.util.hashCode(JSON.stringify(gradient));if(!this.paper.svg.getElementById(gradientId)){var gradientSVGString=['<'+gradient.type+'>',_.map(gradient.stops,function(stop){return'<stop offset="'+stop.offset+'" stop-color="'+stop.color+'" stop-opacity="'+(_.isFinite(stop.opacity)?stop.opacity:1)+'" />'}).join(''),'</'+gradient.type+'>'].join('');var gradientElement=V(gradientSVGString);if(gradient.attrs){gradientElement.attr(gradient.attrs);}
gradientElement.node.id=gradientId;V(this.paper.svg).defs().append(gradientElement);}
$selected.each(function(){V(this).attr(attr,'url(#'+gradientId+')');});},getSelector:function(el,selector){if(el===this.el){return selector;}
var index=$(el).index();selector=el.tagName+':nth-child('+(index+1)+')'+' '+(selector||'');return this.getSelector($(el).parent()[0],selector+' ');},pointerdblclick:function(evt,x,y){this.notify('cell:pointerdblclick',evt,x,y);},pointerdown:function(evt,x,y){if(this.model.collection){this.model.trigger('batch:start');this._collection=this.model.collection;}
this.notify('cell:pointerdown',evt,x,y);},pointermove:function(evt,x,y){this.notify('cell:pointermove',evt,x,y);},pointerup:function(evt,x,y){this.notify('cell:pointerup',evt,x,y);if(this._collection){this._collection.trigger('batch:stop');delete this._collection;}}});if(typeof exports==='object'){module.exports.Cell=joint.dia.Cell;module.exports.CellView=joint.dia.CellView;}
if(typeof exports==='object'){var joint={util:require('./core').util,dia:{Cell:require('./joint.dia.cell').Cell,CellView:require('./joint.dia.cell').CellView}};var Backbone=require('backbone');var _=require('lodash');}
joint.dia.Element=joint.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(x,y){this.set('position',{x:x,y:y});},translate:function(tx,ty,opt){ty=ty||0;if(tx===0&&ty===0){return this;}
var position=this.get('position')||{x:0,y:0};var translatedPosition={x:position.x+tx||0,y:position.y+ty||0};if(opt&&opt.transition){if(!_.isObject(opt.transition))opt.transition={};this.transition('position',translatedPosition,_.extend({},opt.transition,{valueFunction:joint.util.interpolate.object}));}else{this.set('position',translatedPosition,opt);_.invoke(this.getEmbeddedCells(),'translate',tx,ty,opt);}
return this;},resize:function(width,height){this.trigger('batch:start');this.set('size',{width:width,height:height});this.trigger('batch:stop');return this;},rotate:function(angle,absolute){return this.set('angle',absolute?angle:((this.get('angle')||0)+angle)%360);},getBBox:function(){var position=this.get('position');var size=this.get('size');return g.rect(position.x,position.y,size.width,size.height);}});joint.dia.ElementView=joint.dia.CellView.extend({className:function(){return'element '+this.model.get('type').split('.').join(' ');},initialize:function(){_.bindAll(this,'translate','resize','rotate');joint.dia.CellView.prototype.initialize.apply(this,arguments);this.listenTo(this.model,'change:position',this.translate);this.listenTo(this.model,'change:size',this.resize);this.listenTo(this.model,'change:angle',this.rotate);},update:function(cell,renderingOnlyAttrs){var allAttrs=this.model.get('attrs');var rotatable=V(this.$('.rotatable')[0]);if(rotatable){var rotation=rotatable.attr('transform');rotatable.attr('transform','');}
var relativelyPositioned=[];_.each(renderingOnlyAttrs||allAttrs,function(attrs,selector){var $selected=this.findBySelector(selector);if($selected.length===0)return;var specialAttributes=['style','text','html','ref-x','ref-y','ref-dx','ref-dy','ref','x-alignment','y-alignment','port'];if(_.isObject(attrs.filter)){specialAttributes.push('filter');this.applyFilter(selector,attrs.filter);}
if(_.isObject(attrs.fill)){specialAttributes.push('fill');this.applyGradient(selector,'fill',attrs.fill);}
if(_.isObject(attrs.stroke)){specialAttributes.push('stroke');this.applyGradient(selector,'stroke',attrs.stroke);}
var finalAttributes=_.omit(attrs,specialAttributes);$selected.each(function(){V(this).attr(finalAttributes);});if(attrs.port){$selected.attr('port',_.isUndefined(attrs.port.id)?attrs.port:attrs.port.id);}
if(attrs.style){$selected.css(attrs.style);}
if(!_.isUndefined(attrs.text)){$selected.each(function(){V(this).text(attrs.text+'');});}
if(!_.isUndefined(attrs.html)){$selected.each(function(){$(this).html(attrs.html+'');});}
if(!_.isUndefined(attrs['ref-x'])||!_.isUndefined(attrs['ref-y'])||!_.isUndefined(attrs['ref-dx'])||!_.isUndefined(attrs['ref-dy'])||!_.isUndefined(attrs['x-alignment'])||!_.isUndefined(attrs['y-alignment'])){relativelyPositioned.push($selected);}},this);var bbox=this.el.getBBox();renderingOnlyAttrs=renderingOnlyAttrs||{};_.each(relativelyPositioned,function($el){var renderingOnlyElAttrs=renderingOnlyAttrs[$el.selector];var elAttrs=renderingOnlyElAttrs?_.merge({},allAttrs[$el.selector],renderingOnlyElAttrs):allAttrs[$el.selector];this.positionRelative($el,bbox,elAttrs);},this);if(rotatable){rotatable.attr('transform',rotation||'');}},positionRelative:function($el,bbox,elAttrs){var ref=elAttrs['ref'];var refX=parseFloat(elAttrs['ref-x']);var refY=parseFloat(elAttrs['ref-y']);var refDx=parseFloat(elAttrs['ref-dx']);var refDy=parseFloat(elAttrs['ref-dy']);var yAlignment=elAttrs['y-alignment'];var xAlignment=elAttrs['x-alignment'];var isScalable=_.contains(_.pluck(_.pluck($el.parents('g'),'className'),'baseVal'),'scalable');if(ref){bbox=V(this.findBySelector(ref)[0]).bbox(false,this.el);}
var vel=V($el[0]);if(vel.attr('transform')){vel.attr('transform',vel.attr('transform').replace(/translate\([^)]*\)/g,'')||'');}
function isDefined(x){return _.isNumber(x)&&!_.isNaN(x);}
var tx=0;var ty=0;if(isDefined(refDx)){if(isScalable){var scale=V(this.$('.scalable')[0]).scale();tx=bbox.x+bbox.width+refDx/scale.sx;}else{tx=bbox.x+bbox.width+refDx;}}
if(isDefined(refDy)){if(isScalable){var scale=V(this.$('.scalable')[0]).scale();ty=bbox.y+bbox.height+refDy/scale.sy;}else{ty=bbox.y+bbox.height+refDy;}}
if(isDefined(refX)){if(refX>0&&refX<1){tx=bbox.x+bbox.width*refX;}else if(isScalable){var scale=V(this.$('.scalable')[0]).scale();tx=bbox.x+refX/scale.sx;}else{tx=bbox.x+refX;}}
if(isDefined(refY)){if(refY>0&&refY<1){ty=bbox.y+bbox.height*refY;}else if(isScalable){var scale=V(this.$('.scalable')[0]).scale();ty=bbox.y+refY/scale.sy;}else{ty=bbox.y+refY;}}
var velbbox=vel.bbox(false,this.paper.viewport);if(yAlignment==='middle'){ty-=velbbox.height/2;}else if(isDefined(yAlignment)){ty+=(yAlignment>0&&yAlignment<1)?velbbox.height*yAlignment:yAlignment;}
if(xAlignment==='middle'){tx-=velbbox.width/2;}else if(isDefined(xAlignment)){tx+=(xAlignment>0&&xAlignment<1)?velbbox.width*xAlignment:xAlignment;}
vel.translate(tx,ty);},render:function(){var markup=this.model.markup||this.model.get('markup');if(markup){var nodes=V(markup);V(this.el).append(nodes);}else{throw new Error('properties.markup is missing while the default render() implementation is used.');}
this.update();this.resize();this.rotate();this.translate();return this;},scale:function(sx,sy){V(this.el).scale(sx,sy);},resize:function(){var size=this.model.get('size')||{width:1,height:1};var angle=this.model.get('angle')||0;var scalable=V(this.$('.scalable')[0]);if(!scalable){return;}
var scalableBbox=scalable.bbox(true);scalable.attr('transform','scale('+(size.width/scalableBbox.width)+','+(size.height/scalableBbox.height)+')');var rotatable=V(this.$('.rotatable')[0]);var rotation=rotatable&&rotatable.attr('transform');if(rotation&&rotation!=='null'){rotatable.attr('transform',rotation+' rotate('+(-angle)+','+(size.width/2)+','+(size.height/2)+')');var rotatableBbox=scalable.bbox(false,this.paper.viewport);this.model.set('position',{x:rotatableBbox.x,y:rotatableBbox.y});this.rotate();}
this.update();},translate:function(model,changes,opt){var position=this.model.get('position')||{x:0,y:0};V(this.el).attr('transform','translate('+position.x+','+position.y+')');},rotate:function(){var rotatable=V(this.$('.rotatable')[0]);if(!rotatable){return;}
var angle=this.model.get('angle')||0;var size=this.model.get('size')||{width:1,height:1};var ox=size.width/2;var oy=size.height/2;rotatable.attr('transform','rotate('+angle+','+ox+','+oy+')');},pointerdown:function(evt,x,y){if(evt.target.getAttribute('magnet')&&this.paper.options.validateMagnet.call(this.paper,this,evt.target)){this.model.trigger('batch:start');var link=this.paper.getDefaultLink(this,evt.target);link.set({source:{id:this.model.id,selector:this.getSelector(evt.target),port:$(evt.target).attr('port')},target:{x:x,y:y}});this.paper.model.addCell(link);this._linkView=this.paper.findViewByModel(link);this._linkView.startArrowheadMove('target');}else{this._dx=x;this._dy=y;joint.dia.CellView.prototype.pointerdown.apply(this,arguments);}},pointermove:function(evt,x,y){if(this._linkView){this._linkView.pointermove(evt,x,y);}else{var grid=this.paper.options.gridSize;if(this.options.interactive!==false){var position=this.model.get('position');this.model.translate(g.snapToGrid(position.x,grid)-position.x+g.snapToGrid(x-this._dx,grid),g.snapToGrid(position.y,grid)-position.y+g.snapToGrid(y-this._dy,grid));}
this._dx=g.snapToGrid(x,grid);this._dy=g.snapToGrid(y,grid);joint.dia.CellView.prototype.pointermove.apply(this,arguments);}},pointerup:function(evt,x,y){if(this._linkView){this._linkView.pointerup(evt,x,y);delete this._linkView;this.model.trigger('batch:stop');}else{joint.dia.CellView.prototype.pointerup.apply(this,arguments);}}});if(typeof exports==='object'){module.exports.Element=joint.dia.Element;module.exports.ElementView=joint.dia.ElementView;}
if(typeof exports==='object'){var joint={dia:{Cell:require('./joint.dia.cell').Cell,CellView:require('./joint.dia.cell').CellView}};var Backbone=require('backbone');var _=require('lodash');var g=require('./geometry').g;}
joint.dia.Link=joint.dia.Cell.extend({markup:['<path class="connection" stroke="black"/>','<path class="marker-source" fill="black" stroke="black" />','<path class="marker-target" fill="black" stroke="black" />','<path class="connection-wrap"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(''),labelMarkup:['<g class="label">','<rect />','<text />','</g>'].join(''),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>','<title>Remove link.</title>','</g>','<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>','<title>Link options.</title>','</g>','</g>'].join(''),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">','<title>Remove vertex.</title>','</path>','</g>'].join(''),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />','</g>'].join(''),defaults:{type:'link'},disconnect:function(){return this.set({source:g.point(0,0),target:g.point(0,0)});},label:function(idx,value){idx=idx||0;var labels=this.get('labels')||[];if(arguments.length===0||arguments.length===1){return labels[idx];}
var newValue=_.merge({},labels[idx],value);var newLabels=labels.slice();newLabels[idx]=newValue;return this.set({labels:newLabels});}});joint.dia.LinkView=joint.dia.CellView.extend({className:'link',options:{shortLinkLength:100},initialize:function(){joint.dia.CellView.prototype.initialize.apply(this,arguments);if(typeof this.constructor.prototype.watchSource!=='function'){this.constructor.prototype.watchSource=this._createWatcher('source');this.constructor.prototype.watchTarget=this._createWatcher('target');}
this._labelCache={};this.startListening();},startListening:function(){this.listenTo(this.model,'change:markup',this.render);this.listenTo(this.model,'change:smooth change:manhattan',this.update);this.listenTo(this.model,'change:toolMarkup',function(){this.renderTools().updateToolsPosition();});this.listenTo(this.model,'change:labels change:labelMarkup',function(){this.renderLabels().updateLabelPositions();});this.listenTo(this.model,'change:vertices change:vertexMarkup',function(){this.renderVertexMarkers().update();});this.listenTo(this.model,'change:source',function(cell,source){this.watchSource(cell,source).update();});this.listenTo(this.model,'change:target',function(cell,target){this.watchTarget(cell,target).update();});},render:function(){this.$el.empty();var children=V(this.model.get('markup')||this.model.markup);if(!_.isArray(children))children=[children];this._V={}
_.each(children,function(child){var c=child.attr('class');c&&(this._V[$.camelCase(c)]=child);},this);if(!this._V.connection)throw new Error('link: no connection path in the markup');this.renderTools();this.renderVertexMarkers();this.renderArrowheadMarkers();V(this.el).append(children);this.renderLabels();this.watchSource(this.model,this.model.get('source')).watchTarget(this.model,this.model.get('target')).update();return this;},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var $labels=$(this._V.labels.node).empty();var labels=this.model.get('labels')||[];if(!labels.length)return this;var labelTemplate=_.template(this.model.get('labelMarkup')||this.model.labelMarkup);var labelNodeInstance=V(labelTemplate());_.each(labels,function(label,idx){var labelNode=labelNodeInstance.clone().node;this._labelCache[idx]=V(labelNode);var $text=$(labelNode).find('text');var $rect=$(labelNode).find('rect');var textAttributes=_.extend({'text-anchor':'middle'},joint.util.getByPath(label,'attrs/text','/'));$text.attr(_.omit(textAttributes,'text'));if(!_.isUndefined(textAttributes.text)){V($text[0]).text(textAttributes.text+'');}
$labels.append(labelNode);var textBbox=V($text[0]).bbox(true,$labels[0]);V($text[0]).translate(0,-textBbox.height/2);var rectAttributes=_.extend({fill:'white',rx:3,ry:3},joint.util.getByPath(label,'attrs/rect','/'));$rect.attr(_.extend(rectAttributes,{x:textBbox.x,y:textBbox.y-textBbox.height/2,width:textBbox.width,height:textBbox.height}));},this);return this;},renderTools:function(){if(!this._V.linkTools)return this;var $tools=$(this._V.linkTools.node).empty();var toolTemplate=_.template(this.model.get('toolMarkup')||this.model.toolMarkup);var tool=V(toolTemplate());$tools.append(tool.node);this._toolCache=tool;return this;},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;var $markerVertices=$(this._V.markerVertices.node).empty();var markupTemplate=_.template(this.model.get('vertexMarkup')||this.model.vertexMarkup);_.each(this.model.get('vertices'),function(vertex,idx){$markerVertices.append(V(markupTemplate(_.extend({idx:idx},vertex))).node);});return this;},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var $markerArrowheads=$(this._V.markerArrowheads.node);$markerArrowheads.empty();var markupTemplate=_.template(this.model.get('arrowheadMarkup')||this.model.arrowheadMarkup);this._sourceArrowhead=V(markupTemplate({end:'source'}));this._targetArrowhead=V(markupTemplate({end:'target'}));$markerArrowheads.append(this._sourceArrowhead.node,this._targetArrowhead.node);return this;},update:function(){_.each(this.model.get('attrs'),function(attrs,selector){if(_.isObject(attrs.filter)){this.findBySelector(selector).attr(_.omit(attrs,'filter'));this.applyFilter(selector,attrs.filter);}else{this.findBySelector(selector).attr(attrs);}},this);var vertices=this.model.get('vertices');if(this.model.get('manhattan')){vertices=this.findManhattanRoute(vertices);}
this._firstVertex=_.first(vertices);this._sourcePoint=this.getConnectionPoint('source',this.model.get('source'),this._firstVertex||this.model.get('target')).round();this._lastVertex=_.last(vertices);this._targetPoint=this.getConnectionPoint('target',this.model.get('target'),this._lastVertex||this._sourcePoint);if(this._V.markerSource){this._V.markerSource.translateAndAutoOrient(this._sourcePoint,this._firstVertex||this._targetPoint,this.paper.viewport);}
if(this._V.markerTarget){this._V.markerTarget.translateAndAutoOrient(this._targetPoint,this._lastVertex||this._sourcePoint,this.paper.viewport);}
var pathData=this.getPathData(vertices);this._V.connection.attr('d',pathData);this._V.connectionWrap&&this._V.connectionWrap.attr('d',pathData);this.updateLabelPositions();this.updateToolsPosition();this.updateArrowheadMarkers();return this;},updateLabelPositions:function(){if(!this._V.labels)return this;var labels=this.model.get('labels')||[];if(!labels.length)return this;var connectionElement=this._V.connection.node;var connectionLength=connectionElement.getTotalLength();_.each(labels,function(label,idx){var position=label.position;position=(position>connectionLength)?connectionLength:position;position=(position<0)?connectionLength+position:position;position=position>1?position:connectionLength*position;var labelCoordinates=connectionElement.getPointAtLength(position);this._labelCache[idx].attr('transform','translate('+labelCoordinates.x+', '+labelCoordinates.y+')');},this);return this;},updateToolsPosition:function(){if(!this._V.linkTools)return this;var scale='';var offset=40;if(this.getConnectionLength()<this.options.shortLinkLength){scale='scale(.5)';offset/=2;}
var toolPosition=this.getPointAtLength(offset);this._toolCache.attr('transform','translate('+toolPosition.x+', '+toolPosition.y+') '+scale);return this;},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;if($.css(this._V.markerArrowheads.node,'display')==='none')return this;var sx=this.getConnectionLength()<this.options.shortLinkLength?.5:1
this._sourceArrowhead.scale(sx);this._targetArrowhead.scale(sx);this._sourceArrowhead.translateAndAutoOrient(this._sourcePoint,this._firstVertex||this._targetPoint,this.paper.viewport);this._targetArrowhead.translateAndAutoOrient(this._targetPoint,this._lastVertex||this._sourcePoint,this.paper.viewport);return this;},_createWatcher:function(endType){function watchEnd(link,end){end=end||{};var previousEnd=link.previous(endType)||{};var updateEndFunction=this['_'+endType+'BBoxUpdate'];if(this._isModel(previousEnd)){this.stopListening(this.paper.getModelById(previousEnd.id),'change',updateEndFunction);}
if(this._isModel(end)){this.listenTo(this.paper.getModelById(end.id),'change',updateEndFunction);}
_.bind(updateEndFunction,this)({cacheOnly:true});return this;}
return watchEnd;},_sourceBBoxUpdate:function(update){update=update||{};var end=this.model.get('source');if(this._isModel(end)){var selector=this._makeSelector(end);var view=this.paper.findViewByModel(end.id);var magnetElement=this.paper.viewport.querySelector(selector);this._sourceBbox=view.getStrokeBBox(magnetElement);}else{this._sourceBbox={width:1,height:1,x:end.x,y:end.y};}
if(!update.cacheOnly)this.update();},_targetBBoxUpdate:function(update){update=update||{};var end=this.model.get('target');if(this._isModel(end)){var selector=this._makeSelector(end);var view=this.paper.findViewByModel(end.id);var magnetElement=this.paper.viewport.querySelector(selector);this._targetBbox=view.getStrokeBBox(magnetElement);}else{this._targetBbox={width:1,height:1,x:end.x,y:end.y};}
if(!update.cacheOnly)this.update();},removeVertex:function(idx){var vertices=_.clone(this.model.get('vertices'));if(vertices&&vertices.length){vertices.splice(idx,1);this.model.set('vertices',vertices);}
return this;},addVertex:function(vertex){this.model.set('attrs',this.model.get('attrs')||{});var attrs=this.model.get('attrs');var vertices=(this.model.get('vertices')||[]).slice();var originalVertices=vertices.slice();var path=this._V.connection.node.cloneNode(false);var originalPathLength=path.getTotalLength();var pathLength;var pathLengthTolerance=20;var idx=vertices.length+1;while(idx--){vertices.splice(idx,0,vertex);V(path).attr('d',this.getPathData(vertices));pathLength=path.getTotalLength();if(pathLength-originalPathLength>pathLengthTolerance){vertices=originalVertices.slice();}else{break;}}
this.model.set('vertices',vertices);return Math.max(idx,0);},getPathData:function(vertices){var sourcePoint=g.point(this._sourcePoint);var targetPoint=g.point(this._targetPoint);if(this._V.markerSource){this._markerSourceBbox=this._markerSourceBbox||this._V.markerSource.bbox(true);sourcePoint.move(this._firstVertex||targetPoint,this._markerSourceBbox.width*-this._V.markerSource.scale().sx);}
if(this._V.markerTarget){this._markerTargetBbox=this._markerTargetBbox||this._V.markerTarget.bbox(true);targetPoint.move(this._lastVertex||sourcePoint,this._markerTargetBbox.width*-this._V.markerTarget.scale().sx);}
var d;if(this.model.get('smooth')){if(vertices&&vertices.length){d=g.bezier.curveThroughPoints([sourcePoint].concat(vertices||[]).concat([targetPoint]));}else{var controlPointX=(sourcePoint.x<targetPoint.x)?targetPoint.x-((targetPoint.x-sourcePoint.x)/2):sourcePoint.x-((sourcePoint.x-targetPoint.x)/2);d=['M',sourcePoint.x,sourcePoint.y,'C',controlPointX,sourcePoint.y,controlPointX,targetPoint.y,targetPoint.x,targetPoint.y];}}else{d=['M',sourcePoint.x,sourcePoint.y];_.each(vertices,function(vertex){d.push(vertex.x,vertex.y);});d.push(targetPoint.x,targetPoint.y);}
return d.join(' ');},getConnectionPoint:function(end,selectorOrPoint,referenceSelectorOrPoint){var spot;if(this._isPoint(selectorOrPoint)){spot=g.point(selectorOrPoint);}else{var spotBbox=end==='source'?this._sourceBbox:this._targetBbox;var reference;if(this._isPoint(referenceSelectorOrPoint)){reference=g.point(referenceSelectorOrPoint);}else{var referenceBbox=end==='source'?this._targetBbox:this._sourceBbox;reference=g.rect(referenceBbox).intersectionWithLineFromCenterToPoint(g.rect(spotBbox).center());reference=reference||g.rect(referenceBbox).center();}
if(this.paper.options.perpendicularLinks){var horizontalLineRect=g.rect(0,reference.y,this.paper.options.width,1);var verticalLineRect=g.rect(reference.x,0,1,this.paper.options.height);var nearestSide;if(horizontalLineRect.intersect(g.rect(spotBbox))){nearestSide=g.rect(spotBbox).sideNearestToPoint(reference);switch(nearestSide){case'left':spot=g.point(spotBbox.x,reference.y);break;case'right':spot=g.point(spotBbox.x+spotBbox.width,reference.y);break;default:spot=g.rect(spotBbox).center();break;}}else if(verticalLineRect.intersect(g.rect(spotBbox))){nearestSide=g.rect(spotBbox).sideNearestToPoint(reference);switch(nearestSide){case'top':spot=g.point(reference.x,spotBbox.y);break;case'bottom':spot=g.point(reference.x,spotBbox.y+spotBbox.height);break;default:spot=g.rect(spotBbox).center();break;}}else{spot=g.rect(spotBbox).intersectionWithLineFromCenterToPoint(reference);spot=spot||g.rect(spotBbox).center();}}else{spot=g.rect(spotBbox).intersectionWithLineFromCenterToPoint(reference);spot=spot||g.rect(spotBbox).center();}}
return spot;},_isModel:function(end){return end&&end.id;},_isPoint:function(end){return!this._isModel(end);},_makeSelector:function(end){var selector='[model-id="'+end.id+'"]';if(end.port){selector+=' [port="'+end.port+'"]';}else if(end.selector){selector+=' '+end.selector;}
return selector;},findManhattanRoute:function(vertices){vertices=(vertices||[]).slice();var manhattanVertices=[];function direction(p1,p2){if(p1.y<p2.y&&p1.x===p2.x){return'down';}else if(p1.y>p2.y&&p1.x===p2.x){return'up';}else if(p1.x<p2.x&&p1.y===p2.y){return'right';}
return'left';}
function bestDirection(p1,p2,preferredDirection){var directions;if(p1.x<p2.x){if(p1.y>p2.y){directions=['up','right'];}
else if(p1.y<p2.y){directions=['down','right'];}
else{directions=['right'];}}else if(p1.x>p2.x){if(p1.y>p2.y){directions=['up','left'];}
else if(p1.y<p2.y){directions=['down','left'];}
else{directions=['left'];}}else{if(p1.y>p2.y){directions=['up'];}
else{directions=['down'];}}
if(_.contains(directions,preferredDirection)){return preferredDirection;}
var direction=_.first(directions);switch(preferredDirection){case'down':if(direction==='up')return _.last(directions);break;case'up':if(direction==='down')return _.last(directions);break;case'left':if(direction==='right')return _.last(directions);break;case'right':if(direction==='left')return _.last(directions);break;}
return direction;}
function findMiddleVertex(p1,p2,preferredDirection){var direction=bestDirection(p1,p2,preferredDirection);if(direction==='down'||direction==='up'){return{x:p1.x,y:p2.y,d:direction};}
return{x:p2.x,y:p1.y,d:direction};}
var sourceCenter=g.rect(this._sourceBbox).center();var targetCenter=g.rect(this._targetBbox).center();vertices.unshift(sourceCenter);vertices.push(targetCenter);var manhattanVertex;var lastManhattanVertex;var vertex;var nextVertex;for(var i=0;i<vertices.length-1;i++){vertex=vertices[i];nextVertex=vertices[i+1];lastManhattanVertex=_.last(manhattanVertices);if(i>0){manhattanVertex=vertex;manhattanVertex.d=lastManhattanVertex?direction(lastManhattanVertex,vertex):'top';manhattanVertices.push(manhattanVertex);lastManhattanVertex=manhattanVertex;}
var d=lastManhattanVertex&&lastManhattanVertex.d;manhattanVertex=findMiddleVertex(vertex,nextVertex,d);if(!g.point(manhattanVertex).equals(g.point(vertex))&&!g.point(manhattanVertex).equals(g.point(nextVertex))){manhattanVertices.push(manhattanVertex);}}
return manhattanVertices;},getConnectionLength:function(){return this._V.connection.node.getTotalLength();},getPointAtLength:function(length){return this._V.connection.node.getPointAtLength(length);},_beforeArrowheadMove:function(){this.model.trigger('batch:start');this._z=this.model.get('z');this.model.set('z',Number.MAX_VALUE);this.el.style.pointerEvents='none';},_afterArrowheadMove:function(){if(this._z){this.model.set('z',this._z);delete this._z;}
this.el.style.pointerEvents='visiblePainted';this.model.trigger('batch:stop');},_createValidateConnectionArgs:function(arrowhead){var args=[];args[4]=arrowhead;args[5]=this;var oppositeArrowhead,i=0,j=0;if(arrowhead==='source'){i=2;oppositeArrowhead='target';}else{j=2;oppositeArrowhead='source';}
var end=this.model.get(oppositeArrowhead);if(end.id){args[i]=this.paper.findViewByModel(end.id)
args[i+1]=end.selector&&args[i].el.querySelector(end.selector);}
function validateConnectionArgs(cellView,magnet){args[j]=cellView;args[j+1]=cellView.el===magnet?undefined:magnet;return args;}
return validateConnectionArgs;},startArrowheadMove:function(end){this._action='arrowhead-move';this._arrowhead=end;this._beforeArrowheadMove();this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead);},pointerdown:function(evt,x,y){joint.dia.CellView.prototype.pointerdown.apply(this,arguments);this._dx=x;this._dy=y;if(this.options.interactive===false)return;var className=evt.target.getAttribute('class');switch(className){case'marker-vertex':this._action='vertex-move';this._vertexIdx=evt.target.getAttribute('idx');break;case'marker-vertex-remove':case'marker-vertex-remove-area':this.removeVertex(evt.target.getAttribute('idx'));break;case'marker-arrowhead':this.startArrowheadMove(evt.target.getAttribute('end'));break;default:var targetParentEvent=evt.target.parentNode.getAttribute('event');if(targetParentEvent){if(targetParentEvent==='remove'){this.model.remove();}else{this.paper.trigger(targetParentEvent,evt,this,x,y);}}else{this._vertexIdx=this.addVertex({x:x,y:y});this._action='vertex-move';}}},pointermove:function(evt,x,y){joint.dia.CellView.prototype.pointermove.apply(this,arguments);switch(this._action){case'vertex-move':var vertices=_.clone(this.model.get('vertices'));vertices[this._vertexIdx]={x:x,y:y};this.model.set('vertices',vertices);break;case'arrowhead-move':if(this.paper.options.snapLinks){var r=this.paper.options.snapLinks.radius||50;var viewsInArea=this.paper.findViewsInArea({x:x-r,y:y-r,width:2*r,height:2*r});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector);this._closestView=this._closestEnd=null;var pointer=g.point(x,y);var distance,minDistance=Number.MAX_VALUE;_.each(viewsInArea,function(view){if(view.el.getAttribute('magnet')!=='false'){distance=view.model.getBBox().center().distance(pointer);if(distance<r&&distance<minDistance){if(this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(view,null))){minDistance=distance;this._closestView=view;this._closestEnd={id:view.model.id};}}}
view.$('[magnet]').each(_.bind(function(index,magnet){var bbox=V(magnet).bbox(false,this.paper.viewport);distance=pointer.distance({x:bbox.x+bbox.width/2,y:bbox.y+bbox.height/2});if(distance<r&&distance<minDistance){if(this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(view,magnet))){minDistance=distance;this._closestView=view;this._closestEnd={id:view.model.id,selector:view.getSelector(magnet),port:magnet.getAttribute('port')}}}},this));},this);this._closestView&&this._closestView.highlight(this._closestEnd.selector);this.model.set(this._arrowhead,this._closestEnd||{x:x,y:y});}else{var target=(evt.type==='mousemove')?evt.target:document.elementFromPoint(evt.clientX,evt.clientY)
if(this._targetEvent!==target){this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer);this._viewUnderPointer=this.paper.findView(target);if(this._viewUnderPointer){this._magnetUnderPointer=this._viewUnderPointer.findMagnet(target);if(this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))){this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer);}else{this._magnetUnderPointer=null;}}else{this._magnetUnderPointer=null;}}
this._targetEvent=target;this.model.set(this._arrowhead,{x:x,y:y});}
break;}
this._dx=x;this._dy=y;},pointerup:function(evt){joint.dia.CellView.prototype.pointerup.apply(this,arguments);if(this._action==='arrowhead-move'){if(this.paper.options.snapLinks){this._closestView&&this._closestView.unhighlight(this._closestEnd.selector);this._closestView=this._closestEnd=null;}else{if(this._magnetUnderPointer){this._viewUnderPointer.unhighlight(this._magnetUnderPointer);this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:$(this._magnetUnderPointer).attr('port')});}
delete this._viewUnderPointer;delete this._magnetUnderPointer;delete this._staticView;delete this._staticMagnet;}
this._afterArrowheadMove();}
delete this._action;}});if(typeof exports==='object'){module.exports.Link=joint.dia.Link;module.exports.LinkView=joint.dia.LinkView;}
joint.dia.Paper=Backbone.View.extend({options:{width:800,height:600,gridSize:50,perpendicularLinks:false,elementView:joint.dia.ElementView,linkView:joint.dia.LinkView,snapLinks:false,defaultLink:new joint.dia.Link,validateMagnet:function(cellView,magnet){return magnet.getAttribute('magnet')!=='passive';},validateConnection:function(cellViewS,magnetS,cellViewT,magnetT,end,linkView){return(end==='target'?cellViewT:cellViewS)instanceof joint.dia.ElementView;}},events:{'mousedown':'pointerdown','dblclick':'mousedblclick','touchstart':'pointerdown','mousemove':'pointermove','touchmove':'pointermove'},initialize:function(){_.bindAll(this,'addCell','sortCells','resetCells','pointerup');this.svg=V('svg').node;this.viewport=V('g').node;V(this.svg).append(V('defs').node);V(this.viewport).attr({'class':'viewport'});V(this.svg).append(this.viewport);this.$el.append(this.svg);this.setDimensions();this.listenTo(this.model,'add',this.addCell);this.listenTo(this.model,'reset',this.resetCells);this.listenTo(this.model,'sort',this.sortCells);$(document).on('mouseup touchend',this.pointerup);},remove:function(){$(document).off('mouseup touchend',this.pointerup);Backbone.View.prototype.remove.call(this);},setDimensions:function(width,height){if(width)this.options.width=width;if(height)this.options.height=height;V(this.svg).attr('width',this.options.width);V(this.svg).attr('height',this.options.height);this.trigger('resize');},fitToContent:function(gridWidth,gridHeight,padding){gridWidth=gridWidth||1;gridHeight=gridHeight||1;padding=padding||0;var bbox=V(this.viewport).bbox(true,this.svg);var calcWidth=Math.ceil((bbox.width+bbox.x)/gridWidth)*gridWidth;var calcHeight=Math.ceil((bbox.height+bbox.y)/gridHeight)*gridHeight;calcWidth+=padding;calcHeight+=padding;if(calcWidth!=this.options.width||calcHeight!=this.options.height){this.setDimensions(calcWidth||this.options.width,calcHeight||this.options.height);}},getContentBBox:function(){var crect=this.viewport.getBoundingClientRect();var ctm=this.viewport.getScreenCTM();var bbox=g.rect(Math.abs(crect.left-ctm.e),Math.abs(crect.top-ctm.f),crect.width,crect.height);return bbox;},createViewForModel:function(cell){var view;var type=cell.get('type');var module=type.split('.')[0];var entity=type.split('.')[1];if(joint.shapes[module]&&joint.shapes[module][entity+'View']){view=new joint.shapes[module][entity+'View']({model:cell,interactive:this.options.interactive});}else if(cell instanceof joint.dia.Element){view=new this.options.elementView({model:cell,interactive:this.options.interactive});}else{view=new this.options.linkView({model:cell,interactive:this.options.interactive});}
return view;},addCell:function(cell){var view=this.createViewForModel(cell);V(this.viewport).append(view.el);view.paper=this;view.render();$(view.el).find('image').on('dragstart',function(){return false;});},resetCells:function(cellsCollection){$(this.viewport).empty();var cells=cellsCollection.models.slice();cells.sort(function(a,b){return a instanceof joint.dia.Link?1:-1;});_.each(cells,this.addCell,this);this.sortCells();},sortCells:function(){var $cells=$(this.viewport).children('[model-id]');var cells=this.model.get('cells');$cells.sortElements(function(a,b){var cellA=cells.get($(a).attr('model-id'));var cellB=cells.get($(b).attr('model-id'));return(cellA.get('z')||0)>(cellB.get('z')||0)?1:-1;});},scale:function(sx,sy,ox,oy){if(!ox){ox=0;oy=0;}
V(this.viewport).attr('transform','');if(ox||oy){V(this.viewport).translate(-ox*(sx-1),-oy*(sy-1));}
V(this.viewport).scale(sx,sy);this.trigger('scale',ox,oy);return this;},rotate:function(deg,ox,oy){if(_.isUndefined(ox)){var bbox=this.viewport.getBBox();ox=bbox.width/2;oy=bbox.height/2;}
V(this.viewport).rotate(deg,ox,oy);},findView:function(el){var $el=this.$(el);if($el.length===0||$el[0]===this.el){return undefined;}
if($el.data('view')){return $el.data('view');}
return this.findView($el.parent());},findViewByModel:function(cell){var id=_.isString(cell)?cell:cell.id;var $view=this.$('[model-id="'+id+'"]');if($view.length){return $view.data('view');}
return undefined;},findViewsFromPoint:function(p){p=g.point(p);var views=_.map(this.model.getElements(),this.findViewByModel);return _.filter(views,function(view){return g.rect(V(view.el).bbox(false,this.viewport)).containsPoint(p);},this);},findViewsInArea:function(r){r=g.rect(r);var views=_.map(this.model.getElements(),this.findViewByModel);return _.filter(views,function(view){return r.intersect(g.rect(V(view.el).bbox(false,this.viewport)));},this);},getModelById:function(id){return this.model.getCell(id);},snapToGrid:function(p){var localPoint=V(this.viewport).toLocalPoint(p.x,p.y);return{x:g.snapToGrid(localPoint.x,this.options.gridSize),y:g.snapToGrid(localPoint.y,this.options.gridSize)};},getDefaultLink:function(cellView,magnet){return _.isFunction(this.options.defaultLink)?this.options.defultLink.call(this,cellView,magnet):this.options.defaultLink.clone();},mousedblclick:function(evt){evt.preventDefault();evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});if(view){view.pointerdblclick(evt,localPoint.x,localPoint.y);}else{this.trigger('blank:pointerdblclick',evt,localPoint.x,localPoint.y);}},pointerdown:function(evt){evt.preventDefault();evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});if(view){this.sourceView=view;view.pointerdown(evt,localPoint.x,localPoint.y);}else{this.trigger('blank:pointerdown',evt,localPoint.x,localPoint.y);}},pointermove:function(evt){evt.preventDefault();evt=joint.util.normalizeEvent(evt);if(this.sourceView){var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});this.sourceView.pointermove(evt,localPoint.x,localPoint.y);}},pointerup:function(evt){evt=joint.util.normalizeEvent(evt);var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});if(this.sourceView){this.sourceView.pointerup(evt,localPoint.x,localPoint.y);this.sourceView=null;}else{this.trigger('blank:pointerup',evt,localPoint.x,localPoint.y);}}});if(typeof exports==='object'){var joint={util:require('../src/core').util,shapes:{},dia:{Element:require('../src/joint.dia.element').Element}};var _=require('lodash');}
joint.shapes.basic={};joint.shapes.basic.Generic=joint.dia.Element.extend({defaults:joint.util.deepSupplement({type:'basic.Generic',attrs:{'.':{fill:'#FFFFFF',stroke:'none'}}},joint.dia.Element.prototype.defaults)});joint.shapes.basic.Rect=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:joint.util.deepSupplement({type:'basic.Rect',attrs:{'rect':{fill:'#FFFFFF',stroke:'black',width:100,height:60},'text':{'font-size':14,text:'','ref-x':.5,'ref-y':.5,ref:'rect','y-alignment':'middle','x-alignment':'middle',fill:'black','font-family':'Arial, helvetica, sans-serif'}}},joint.shapes.basic.Generic.prototype.defaults)});joint.shapes.basic.Text=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:joint.util.deepSupplement({type:'basic.Text',attrs:{'text':{'font-size':18,fill:'black'}}},joint.shapes.basic.Generic.prototype.defaults)});joint.shapes.basic.Circle=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:joint.util.deepSupplement({type:'basic.Circle',size:{width:60,height:60},attrs:{'circle':{fill:'#FFFFFF',stroke:'black',r:30,transform:'translate(30, 30)'},'text':{'font-size':14,text:'','text-anchor':'middle','ref-x':.5,'ref-y':.5,ref:'circle','y-alignment':'middle',fill:'black','font-family':'Arial, helvetica, sans-serif'}}},joint.shapes.basic.Generic.prototype.defaults)});joint.shapes.basic.Image=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:joint.util.deepSupplement({type:'basic.Image',attrs:{'text':{'font-size':14,text:'','text-anchor':'middle','ref-x':.5,'ref-dy':20,ref:'image','y-alignment':'middle',fill:'black','font-family':'Arial, helvetica, sans-serif'}}},joint.shapes.basic.Generic.prototype.defaults)});joint.shapes.basic.Path=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:joint.util.deepSupplement({type:'basic.Path',size:{width:60,height:60},attrs:{'path':{fill:'#FFFFFF',stroke:'black'},'text':{'font-size':14,text:'','text-anchor':'middle','ref-x':.5,'ref-dy':20,ref:'path','y-alignment':'middle',fill:'black','font-family':'Arial, helvetica, sans-serif'}}},joint.shapes.basic.Generic.prototype.defaults)});joint.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs();this.on('change:inPorts change:outPorts',this.updatePortsAttrs,this);this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments);},updatePortsAttrs:function(eventName){var currAttrs=this.get('attrs');_.each(this._portSelectors,function(selector){if(currAttrs[selector])delete currAttrs[selector];});this._portSelectors=[];var attrs={};_.each(this.get('inPorts'),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,'.inPorts','in');this._portSelectors=this._portSelectors.concat(_.keys(portAttributes));_.extend(attrs,portAttributes);},this);_.each(this.get('outPorts'),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,'.outPorts','out');this._portSelectors=this._portSelectors.concat(_.keys(portAttributes));_.extend(attrs,portAttributes);},this);this.attr(attrs,{silent:true});this.processPorts();this.trigger('process:ports');},getPortSelector:function(name){var selector='.inPorts';var index=this.get('inPorts').indexOf(name);if(index<0){selector='.outPorts';index=this.get('outPorts').indexOf(name);if(index<0)throw new Error("getPortSelector(): Port doesn't exist.");}
return selector+'>g:nth-child('+(index+1)+')>circle';}};joint.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,'process:ports',this.update);joint.dia.ElementView.prototype.initialize.apply(this,arguments);},update:function(){this.renderPorts();joint.dia.ElementView.prototype.update.apply(this,arguments);},renderPorts:function(){var $inPorts=this.$('.inPorts').empty();var $outPorts=this.$('.outPorts').empty();var portTemplate=_.template(this.model.portMarkup);_.each(_.filter(this.model.ports,function(p){return p.type==='in'}),function(port,index){$inPorts.append(V(portTemplate({id:index,port:port})).node);});_.each(_.filter(this.model.ports,function(p){return p.type==='out'}),function(port,index){$outPorts.append(V(portTemplate({id:index,port:port})).node);});}};joint.shapes.basic.TextBlock=joint.shapes.basic.Rect.extend({markup:['<g class="rotatable"><g class="scalable"><rect/></g><switch>','<foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj">','<body xmlns="http://www.w3.org/1999/xhtml"><div/></body>','</foreignObject>','<svg overflow="hidden"><text/></svg>','</switch></g>'].join(''),defaults:joint.util.deepSupplement({type:'basic.TextBlock',content:''},joint.shapes.basic.Rect.prototype.defaults),initialize:function(){if(typeof SVGForeignObjectElement!=='undefined'){this.setForeignObjectSize(this,this.get('size'));this.setDivContent(this,this.get('content'));this.listenTo(this,'change:size',this.setForeignObjectSize);this.listenTo(this,'change:content',this.setDivContent);}else{this.setSvgSize(this,this.get('size'));this.setTextContent(this,this.get('content'));this.listenTo(this,'change:size',this.setSvgSize);this.listenTo(this,'change:content',this.setTextContent);}
joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments);},setForeignObjectSize:function(cell,size){cell.attr({'.fobj':_.clone(size),div:{style:_.clone(size)}});},setSvgSize:function(cell,size){cell.attr({svg:_.clone(size)});},setDivContent:function(cell,content){cell.attr({div:{html:content}});},setTextContent:function(cell,content){cell.attr({text:{text:content}});}});if(typeof exports==='object'){module.exports=joint.shapes.basic;}